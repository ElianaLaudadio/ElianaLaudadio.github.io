<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Training Dashboard &#x1F4AA;</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <!-- SUPABASE + SHARED AUTH -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/myfolder/js/auth.js?v=5"></script>

  <style>
    :root {
      --bg: #f5f4f2;
      --fg: #111111;
      --muted: #555555;
      --card-bg: #ffffff;
      --hover: #ece9e6;
      --border: #111111;
      --accent: #000000;
    }

    * { box-sizing: border-box; }

    body {
      font-family: 'Atkinson Hyperlegible', sans-serif;
      background-color: var(--bg);
      margin: 0;
      padding-top: 80px;
      padding-bottom: 60px;
      color: var(--fg);
    }

    nav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: var(--bg);
      border-bottom: 2px solid var(--border);
      padding: 20px 0;
      text-align: center;
      z-index: 1000;
    }

    nav a {
      color: var(--fg);
      text-decoration: none;
      margin: 0 20px;
      font-size: 16px;
      font-weight: 600;
      position: relative;
    }

    nav a::after {
      content: '';
      position: absolute;
      bottom: -6px;
      left: 0;
      width: 0%;
      height: 2px;
      background: var(--accent);
      transition: width 0.3s ease;
    }

    nav a:hover::after { width: 100%; }

    #hamburger {
      display: none;
      font-size: 36px;
      cursor: pointer;
      color: var(--fg);
    }

    #mobile-menu {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      background: var(--bg);
      border-top: 2px solid var(--border);
      flex-direction: column;
      padding: 16px 0;
      text-align: center;
    }

    #mobile-menu a { display: block; padding: 14px 0; font-size: 18px; }

    main { max-width: 960px; margin: 30px auto; padding: 0 20px; }

    section {
      background: var(--card-bg);
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    h2 {
      font-size: 28px;
      margin-top: 0;
      font-weight: 500;
      text-align: center;
    }

    label { display: block; margin-top: 10px; color: var(--muted); font-weight: 500; }

    input[type="number"], input[type="text"], input[type="date"] {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border-radius: 12px;
      border: 2px solid var(--border);
      font-size: 16px;
      background-color: var(--card-bg);
      color: var(--fg);
    }

    button {
      background-color: var(--hover);
      color: var(--fg);
      border: 2px solid var(--border);
      padding: 12px 16px;
      font-size: 16px;
      border-radius: 12px;
      cursor: pointer;
      margin-top: 15px;
      font-weight: 600;
    }

    button:hover {
      background-color: var(--accent);
      color: #ffffff;
      transform: translateY(-2px);
    }
  </style>
</head>

<body>

<nav>
  <a href="/myfolder/index.html">Home</a>
  <a href="/myfolder/template.html">Goals + Progress</a>
  <a href="/myfolder/workouts.html">Workouts</a>
  <a href="/myfolder/meal_planner.html">Meal Planner</a>

  <span id="hamburger">&#9776;</span>

  <div id="mobile-menu">
    <a href="/myfolder/index.html">Home</a>
    <a href="/myfolder/template.html">Goals + Progress</a>
    <a href="/myfolder/workouts.html">Workouts</a>
    <a href="/myfolder/meal_planner.html">Meal Planner</a>
  </div>
</nav>

<main>

<section id="weight">
  <h2>Weight Tracking</h2>

  <label for="weight-date">Entry Date:</label>
  <input type="date" id="weight-date" />

  <label for="weight-input">Weight (lbs):</label>
  <input type="number" id="weight-input" step="0.1" />

  <div id="weight-buttons">
    <button onclick="addWeight()">Add Entry</button>
    <button onclick="deleteLastEntry()">Delete Last Entry</button>
  </div>

  <canvas id="weightChart"></canvas>
</section>

</main>

<audio id="celebrationSound" src="https://assets.mixkit.co/sfx/preview/mixkit-small-group-cheer-and-applause-518.mp3" preload="auto"></audio>

<script>
const ctx = document.getElementById('weightChart').getContext('2d');
let weightData = JSON.parse(localStorage.getItem('weightEntries')||'[]');

let chart = new Chart(ctx, {
  type:'line',
  data:{
    labels: weightData.map(e=>e.label),
    datasets:[{
      label:'Weight (lbs)',
      data: weightData.map(e=>e.weight),
      borderColor:'#000000',
      backgroundColor:'rgba(0,0,0,0.2)',
      borderWidth:3,
      fill:true,
      tension:0.3,
      pointRadius:6,
      pointBackgroundColor:'#000000'
    }]
  }
});

/* Date only labels */
function makeLabel(entryDate){
  return entryDate;
}

function getTodayDate(){
  const d = new Date();
  d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
  return d.toISOString().split('T')[0];
}

function setDefaultWeightDate(){
  const el = document.getElementById('weight-date');
  if (el && !el.value) el.value = getTodayDate();
}

function getSupabaseClientSafe(){
  const a = window.auth;
  return a && (a.supabase || a.client);
}

/* Load */
async function loadWeightsFromDB(){
  const user = await window.auth.getUser();
  if (!user) return;

  const sb = getSupabaseClientSafe();

  const { data } = await sb
    .from("weight_entries")
    .select("id, entry_date, weight, created_at")
    .eq("user_id", user.id)
    .order("created_at");

  weightData = (data||[]).map(r=>({
    id:r.id,
    date:r.entry_date,
    created_at:r.created_at,
    label: makeLabel(r.entry_date),
    weight:Number(r.weight)
  }));

  localStorage.setItem('weightEntries',JSON.stringify(weightData));
  updateChart();
}

/* Insert */
async function addWeight(){
  const w = parseFloat(document.getElementById('weight-input').value);
  if (isNaN(w)) return alert("Enter valid weight");

  const d = document.getElementById('weight-date').value || getTodayDate();

  const now = new Date().toISOString();

  weightData.push({
    id:null,
    date:d,
    created_at:now,
    label:makeLabel(d),
    weight:w
  });

  updateChart();

  await window.auth.supabase
    .from("weight_entries")
    .insert([{ user_id:(await window.auth.getUser()).id, entry_date:d, weight:w }]);

  await loadWeightsFromDB();
}

/* Delete last */
async function deleteLastEntry(){
  if(!weightData.length) return;

  weightData.sort((a,b)=>a.created_at>b.created_at?1:-1);
  weightData.pop();
  updateChart();

  const user = await window.auth.getUser();

  const { data } = await window.auth.supabase
    .from("weight_entries")
    .select("id")
    .eq("user_id",user.id)
    .order("created_at",{ascending:false})
    .limit(1)
    .maybeSingle();

  if(data){
    await window.auth.supabase
      .from("weight_entries")
      .delete()
      .eq("id",data.id);
  }

  await loadWeightsFromDB();
}

function updateChart(){
  chart.data.labels = weightData.map(e=>e.label);
  chart.data.datasets[0].data = weightData.map(e=>e.weight);
  chart.update();
}

window.onload = async ()=>{
  setDefaultWeightDate();
  await loadWeightsFromDB();
  updateChart();
};
</script>

<!-- AUTH GUARD -->
<script>
(async ()=>{
  await window.auth.requireAuth("/myfolder/index.html");
})();
</script>

</body>
</html>
