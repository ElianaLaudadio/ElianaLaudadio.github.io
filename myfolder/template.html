<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Training Dashboard &#x1F4AA;</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <!-- SUPABASE + SHARED AUTH -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/myfolder/js/auth.js?v=5"></script>

  <style>
    :root {
      --bg: #f5f4f2;
      --fg: #111111;
      --muted: #555555;
      --card-bg: #ffffff;
      --hover: #ece9e6;
      --border: #111111;
      --accent: #000000;
    }

    * { box-sizing: border-box; }

    body {
      font-family: 'Atkinson Hyperlegible', sans-serif;
      background-color: var(--bg);
      margin: 0;
      padding-top: 80px;
      padding-bottom: 60px;
      color: var(--fg);
    }

    nav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: var(--bg);
      border-bottom: 2px solid var(--border);
      padding: 20px 0;
      text-align: center;
      z-index: 1000;
    }

    nav a {
      color: var(--fg);
      text-decoration: none;
      margin: 0 20px;
      font-size: 16px;
      font-weight: 600;
      position: relative;
    }

    nav a::after {
      content: '';
      position: absolute;
      bottom: -6px;
      left: 0;
      width: 0%;
      height: 2px;
      background: var(--accent);
      transition: width 0.3s ease;
    }

    nav a:hover::after { width: 100%; }

    #hamburger {
      display: none;
      font-size: 36px;
      cursor: pointer;
      color: var(--fg);
    }

    #mobile-menu {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      background: var(--bg);
      border-top: 2px solid var(--border);
      flex-direction: column;
      padding: 16px 0;
      text-align: center;
    }

    #mobile-menu a { display: block; padding: 14px 0; font-size: 18px; }

    main { max-width: 960px; margin: 30px auto; padding: 0 20px; }

    section {
      background: var(--card-bg);
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    h2 {
      font-size: 28px;
      margin-top: 0;
      font-weight: 500;
      text-align: center;
    }

    label { display: block; margin-top: 10px; color: var(--muted); font-weight: 500; }

    input[type="number"], input[type="text"], input[type="date"] {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border-radius: 12px;
      border: 2px solid var(--border);
      font-size: 16px;
      background-color: var(--card-bg);
      color: var(--fg);
      transition: border-color 0.3s ease, background 0.3s ease;
    }

    input[type="number"]:focus, input[type="text"]:focus, input[type="date"]:focus {
      border-color: var(--accent);
      outline: none;
      background-color: var(--hover);
    }

    button {
      background-color: var(--hover);
      color: var(--fg);
      border: 2px solid var(--border);
      padding: 12px 16px;
      font-size: 16px;
      border-radius: 12px;
      cursor: pointer;
      margin-top: 15px;
      transition: background-color 0.3s ease, transform 0.2s ease;
      font-weight: 600;
    }

    button:hover {
      background-color: var(--accent);
      color: #ffffff;
      transform: translateY(-2px);
    }

    #weight-buttons { display: flex; justify-content: space-between; gap: 10px; margin-top: 10px; }
    #weight-buttons button { width: 48%; }

    /* Progress Circle */
    .progress-circle {
      width: 140px;
      height: 140px;
      border-radius: 50%;
      margin: 20px auto;
      background: conic-gradient(var(--accent) 0%, var(--accent) 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      font-weight: bold;
      color: #ffffff;
      -webkit-text-stroke: 1px #111111;
      transition: background 0.3s ease;
    }

    .progress-circle span {
      margin-top: 6px;
      font-size: 14px;
      color: #ffffff;
      -webkit-text-stroke: 1px #111111;
    }

    .goals-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .goal-box {
      background: var(--card-bg);
      padding: 15px;
      border-radius: 16px;
      text-align: center;
      color: var(--fg);
      border: 2px solid var(--border);
      box-shadow: 0 8px 20px rgba(0,0,0,0.05);
    }

    canvas { width: 100% !important; height: 300px !important; }

    .message {
      margin-top: 10px;
      font-weight: bold;
      color: var(--accent);
      text-align: center;
      min-height: 24px;
    }

    section p { color: var(--muted); font-size: 16px; margin-top: 10px; }

    #go-to-cart button {
      display: block;
      margin: 15px auto 0 auto;
      width: 200px;
      font-size: 18px;
      padding: 12px 0;
      border-radius: 16px;
      background-color: var(--hover);
      color: var(--fg);
      border: 2px solid var(--border);
      font-weight: 600;
    }

    #go-to-cart button:hover { background-color: var(--accent); color: #ffffff; transform: translateY(-2px); }

    @media (max-width: 600px) {
      nav a { display: none; }
      #hamburger { display: block; font-size: 40px; padding: 10px 0; }
      main { padding: 0 10px; }
      section { padding: 20px 15px; }
      h2 { font-size: 22px; }
      input[type="number"], input[type="text"], input[type="date"] { font-size: 15px; }
      button { width: 100%; font-size: 16px; padding: 12px; }
      #weight-buttons { flex-direction: column; gap: 10px; }
      #weight-buttons button { width: 100%; }
      .progress-circle { width: 120px; height: 120px; font-size: 18px; }
      .progress-circle span { font-size: 12px; }
      .goals-grid { grid-template-columns: 1fr; gap: 15px; }
      #go-to-cart button { width: 100%; font-size: 16px; }
    }
  </style>
</head>
<body>

<nav>
  <a href="/myfolder/index.html">Home</a>
  <a href="/myfolder/template.html">Goals + Progress</a>
  <a href="/myfolder/workouts.html">Workouts</a>
  <a href="/myfolder/meal_planner.html">Meal Planner</a>
  <a href="/myfolder/cart.html">Grocery List</a>
  
  <span id="hamburger">&#9776;</span>
  <div id="mobile-menu">
    
    <a href="/myfolder/index.html">Home</a>
    <a href="/myfolder/template.html">Goals + Progress</a>
    <a href="/myfolder/workouts.html">Workouts</a>
    <a href="/myfolder/meal_planner.html">Meal Planner</a>
    <a href="/myfolder/cart.html">Grocery List</a>
  </div>
</nav>

<main>
  <section id="nutrition"><h2>Nutrition Tracker & Goals</h2></section>

  <section id="weight">
    <h2>Weight Tracking</h2>

    <!-- keep this date picker (nice UX) but it will NOT restrict rows -->
    <label for="weight-date">Entry Date:</label>
    <input type="date" id="weight-date" />

    <label for="weight-input">Weight (lbs):</label>
    <input type="number" id="weight-input" step="0.1" />

    <div id="weight-buttons">
      <button onclick="addWeight()">Add Entry</button>
      <button onclick="deleteLastEntry()">Delete Last Entry</button>
    </div>
    <canvas id="weightChart"></canvas>
  </section>

  <section id="input">
    <h2>Daily Nutrition Input</h2>

    <label for="protein">Protein (grams):</label>
    <input type="number" id="protein" oninput="calculateProgress()" />

    <label for="carbs">Carbs (grams):</label>
    <input type="number" id="carbs" oninput="calculateProgress()" />

    <label for="fat">Fat (grams):</label>
    <input type="number" id="fat" oninput="calculateProgress()" />

    <div class="progress-circle" id="proteinCircle">
      <div id="proteinText">0%</div>
      <span>Protein</span>
    </div>

    <div class="progress-circle" id="calorieCircle">
      <div id="calorieText">0%</div>
      <span>Calories</span>
    </div>

    <div class="message" id="proteinMessage"></div>
    <div class="message" id="calorieMessage"></div>
    <div class="message" id="totalCalories">Total Calories: 0</div>
  </section>

  <section id="goals">
    <h2>Set Your Goals</h2>
    <label for="goal-weight">Goal Weight (lbs):</label>
    <input type="number" id="goal-weight" placeholder="e.g. 150" />
    <label for="calories-goal">Daily Calorie Goal:</label>
    <input type="number" id="calories-goal" placeholder="e.g. 2000" />
    <label for="protein-goal">Protein Goal (g):</label>
    <input type="number" id="protein-goal" placeholder="e.g. 150" />
    <label for="carbs-goal">Carbs (g):</label>
    <input type="number" id="carbs-goal" placeholder="e.g. 250" />
    <label for="fats-goal">Fats (g):</label>
    <input type="number" id="fats-goal" placeholder="e.g. 70" />
    <button onclick="saveGoals()">Save Goals</button>

    <div class="goals-grid">
      <div class="goal-box"><strong>Goal Weight:</strong><br /><span id="display-weight">–</span></div>
      <div class="goal-box"><strong>Calories:</strong><br /><span id="display-calories">–</span></div>
      <div class="goal-box"><strong>Protein:</strong><br /><span id="display-protein">–</span></div>
      <div class="goal-box"><strong>Carbs:</strong><br /><span id="display-carbs">–</span></div>
      <div class="goal-box"><strong>Fats:</strong><br /><span id="display-fats">–</span></div>
    </div>
  </section>


</main>

<audio id="celebrationSound" src="https://assets.mixkit.co/sfx/preview/mixkit-small-group-cheer-and-applause-518.mp3" preload="auto"></audio>

<script>
const ctx = document.getElementById('weightChart').getContext('2d');
let weightData = JSON.parse(localStorage.getItem('weightEntries')||'[]');

let chart = new Chart(ctx, {
  type:'line',
  data:{
    labels: weightData.map(e=>e.label),
    datasets:[{
      label:'Weight (lbs)',
      data: weightData.map(e=>e.weight),
      borderColor:'#000000',
      backgroundColor:'rgba(0,0,0,0.2)',
      borderWidth:3,
      fill:true,
      tension:0.3,
      pointRadius:6,
      pointBackgroundColor:'#000000',
      pointBorderColor:'#111111',
      pointBorderWidth:2
    }]
  },
  options:{
    scales:{
      y:{beginAtZero:false, ticks:{color:'#111',font:{weight:'600'}}, grid:{color:'#ccc'}},
      x:{ticks:{color:'#111',font:{weight:'600'}}, grid:{color:'#ccc'}}
    },
    plugins:{legend:{labels:{color:'#d9c7b1',font:{weight:'600'}}}}
  }
});

/* ✅ local date (NOT UTC) */
function getTodayDate(){
  const d = new Date();
  d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
  return d.toISOString().split('T')[0];
}

/* ✅ default the date picker to today */
function setDefaultWeightDate(){
  const el = document.getElementById('weight-date');
  if (el && !el.value) el.value = getTodayDate();
}

/* -------------------- SUPABASE HELPERS -------------------- */
function getSupabaseClientSafe(){
  const a = window.auth;
  const client = a && (a.supabase || a.client);
  if (!client) console.warn("Supabase client not found on window.auth (expected auth.supabase or auth.client).");
  return client || null;
}

function makeLabel(entryDate){
  return entryDate;
}

/* -------------------- SUPABASE WEIGHT ENTRIES (UNLIMITED ROWS) -------------------- */
async function loadWeightsFromDB(){
  try {
    const a = window.auth;
    if (!a || !a.getUser) return;

    const user = await a.getUser();
    if (!user) return;

    const sb = getSupabaseClientSafe();
    if (!sb) return;

    // ✅ This expects the table: public.weight_entries
    // columns: id, user_id, entry_date, weight, created_at
    const { data, error } = await sb
      .from("weight_entries")
      .select("id, entry_date, weight, created_at")
      .eq("user_id", user.id)
      .order("created_at", { ascending: true });

    if (error) {
      console.warn("Could not load weights from DB:", error.message || error);
      return;
    }

    const rows = data || [];
    console.log(`Loaded ${rows.length} weight point(s) from DB for this user.`);

    // Store id so we can delete the last entry reliably
    weightData = rows.map(r => ({
      id: r.id,
      date: r.entry_date,
      created_at: r.created_at,
      label: makeLabel(r.entry_date, r.created_at),
      weight: Number(r.weight)
    }));

    localStorage.setItem('weightEntries', JSON.stringify(weightData));
    updateChart();
  } catch (e) {
    console.warn("loadWeightsFromDB failed:", e);
  }
}

async function insertWeightToDB(entryDate, weightVal){
  try {
    const a = window.auth;
    if (!a || !a.getUser) return;

    const user = await a.getUser();
    if (!user) return;

    const sb = getSupabaseClientSafe();
    if (!sb) return;

    const payload = {
      user_id: user.id,
      entry_date: entryDate,
      weight: weightVal
    };

    const { error } = await sb
      .from("weight_entries")
      .insert([payload]);

    if (error) console.warn("Could not insert weight to DB:", error.message || error);
  } catch (e) {
    console.warn("insertWeightToDB failed:", e);
  }
}

async function deleteLastWeightFromDB(){
  try {
    const a = window.auth;
    if (!a || !a.getUser) return;

    const user = await a.getUser();
    if (!user) return;

    const sb = getSupabaseClientSafe();
    if (!sb) return;

    // Find the most recent row
    const { data: lastRow, error: selErr } = await sb
      .from("weight_entries")
      .select("id")
      .eq("user_id", user.id)
      .order("created_at", { ascending: false })
      .limit(1)
      .maybeSingle();

    if (selErr) {
      console.warn("Could not find last weight entry:", selErr.message || selErr);
      return;
    }
    if (!lastRow) return;

    const { error: delErr } = await sb
      .from("weight_entries")
      .delete()
      .eq("id", lastRow.id);

    if (delErr) console.warn("Could not delete last weight entry:", delErr.message || delErr);
  } catch (e) {
    console.warn("deleteLastWeightFromDB failed:", e);
  }
}

async function addWeight(){
  const w = parseFloat(document.getElementById('weight-input').value);
  if (isNaN(w)) return alert('Please enter a valid weight.');

  const pickedDate = document.getElementById('weight-date').value || getTodayDate();
  const d = pickedDate;

  // ✅ Unlimited local points: always push a new row
  const nowIso = new Date().toISOString();
  weightData.push({
    id: null,
    date: d,
    created_at: nowIso,
    label: makeLabel(d, nowIso),
    weight: w
  });

  localStorage.setItem('weightEntries', JSON.stringify(weightData));
  updateChart();
  document.getElementById('weight-input').value = '';

  // Save to DB (then reload so IDs/timestamps are accurate)
  await insertWeightToDB(d, w);
  await loadWeightsFromDB();
}

async function deleteLastEntry(){
  if (weightData.length === 0) {
    alert('No entries to delete.');
    return;
  }

  // Remove last point locally (based on created_at)
  weightData.sort((a,b) => (a.created_at > b.created_at ? 1 : -1));
  weightData.pop();

  localStorage.setItem('weightEntries', JSON.stringify(weightData));
  updateChart();

  // Remove last point from DB (true source of truth)
  await deleteLastWeightFromDB();
  await loadWeightsFromDB();
}

function updateChart(){
  chart.data.labels = weightData.map(e => e.label || e.date);
  chart.data.datasets[0].data = weightData.map(e => e.weight);
  chart.update();
}

/* --------- YOUR EXISTING GOALS (unchanged) --------- */
function displayGoals(){
  const g=JSON.parse(localStorage.getItem('macroGoals'));
  if(!g)return;
  document.getElementById('display-weight').textContent=g.weight?g.weight+' lbs':'–';
  document.getElementById('display-calories').textContent=g.calories?g.calories+' kcal':'–';
  document.getElementById('display-protein').textContent=g.protein?g.protein+' g':'–';
  document.getElementById('display-carbs').textContent=g.carbs?g.carbs+' g':'–';
  document.getElementById('display-fats').textContent=g.fats?g.fats+' g':'–';
}

async function loadGoalsFromDB(){
  try {
    const a = window.auth;
    if (!a || !a.getUser) return;

    const user = await a.getUser();
    if (!user) return;

    const sb = getSupabaseClientSafe();
    if (!sb) return;

    const { data, error } = await sb
      .from("macro_goals")
      .select("goal_weight, calories_goal, protein_goal, carbs_goal, fats_goal")
      .eq("user_id", user.id)
      .maybeSingle();

    if (error) return;
    if (!data) return;

    document.getElementById('goal-weight').value   = data.goal_weight ?? '';
    document.getElementById('calories-goal').value = data.calories_goal ?? '';
    document.getElementById('protein-goal').value  = data.protein_goal ?? '';
    document.getElementById('carbs-goal').value    = data.carbs_goal ?? '';
    document.getElementById('fats-goal').value     = data.fats_goal ?? '';

    const g = {
      weight: data.goal_weight ?? '',
      calories: data.calories_goal ?? '',
      protein: data.protein_goal ?? '',
      carbs: data.carbs_goal ?? '',
      fats: data.fats_goal ?? ''
    };
    localStorage.setItem('macroGoals', JSON.stringify(g));
  } catch (e) {}
}

async function saveGoalsToDB(payload){
  try {
    const a = window.auth;
    if (!a || !a.getUser) return;

    const user = await a.getUser();
    if (!user) return;

    const sb = getSupabaseClientSafe();
    if (!sb) return;

    const row = {
      user_id: user.id,
      goal_weight: payload.weight === '' ? null : Number(payload.weight),
      calories_goal: payload.calories === '' ? null : Number(payload.calories),
      protein_goal: payload.protein === '' ? null : Number(payload.protein),
      carbs_goal: payload.carbs === '' ? null : Number(payload.carbs),
      fats_goal: payload.fats === '' ? null : Number(payload.fats),
      updated_at: new Date().toISOString()
    };

    await sb.from("macro_goals").upsert(row, { onConflict: "user_id" });
  } catch (e) {}
}

async function saveGoals(){
  const g={
    weight:document.getElementById('goal-weight').value,
    calories:document.getElementById('calories-goal').value,
    protein:document.getElementById('protein-goal').value,
    carbs:document.getElementById('carbs-goal').value,
    fats:document.getElementById('fats-goal').value
  };

  localStorage.setItem('macroGoals',JSON.stringify(g));
  displayGoals();
  calculateProgress();

  await saveGoalsToDB(g);
}

let proteinConfettiFired=false;let calorieConfettiFired=false;
function calculateProgress(){
  const p=parseFloat(document.getElementById('protein').value)||0;
  const c=parseFloat(document.getElementById('carbs').value)||0;
  const f=parseFloat(document.getElementById('fat').value)||0;
  const total=Math.round(p*4+c*4+f*9);
  document.getElementById('totalCalories').textContent=`Total Calories: ${total}`;
  const goals=JSON.parse(localStorage.getItem('macroGoals'))||{};
  const proteinGoal=parseFloat(goals.protein)||1;
  const calorieGoal=parseFloat(goals.calories)||1;

  const proteinPercent=Math.min(100,(p/proteinGoal)*100);
  const proteinCircle=document.getElementById('proteinCircle');
  const proteinText=document.getElementById('proteinText');
  proteinText.textContent=`${Math.round(proteinPercent)}%`;
  proteinCircle.style.background=`conic-gradient(var(--accent) ${proteinPercent}%, var(--hover) ${proteinPercent}% 100%)`;

  const caloriePercent=Math.min(100,(total/calorieGoal)*100);
  const calorieCircle=document.getElementById('calorieCircle');
  const calorieText=document.getElementById('calorieText');
  calorieText.textContent=`${Math.round(caloriePercent)}%`;
  calorieCircle.style.background=`conic-gradient(var(--accent) ${caloriePercent}%, var(--hover) ${caloriePercent}% 100%)`;

  document.getElementById('proteinMessage').textContent=proteinPercent>=100?'Protein Goal Achieved!':'';
  document.getElementById('calorieMessage').textContent=caloriePercent>=100?'Calorie Goal Achieved!':'';

  const confettiSound=document.getElementById('celebrationSound');
  if(proteinPercent>=100&&!proteinConfettiFired){confetti({particleCount:200,spread:100,origin:{y:0.6}});confettiSound.play();proteinConfettiFired=true;}else if(proteinPercent<100)proteinConfettiFired=false;
  if(caloriePercent>=100&&!calorieConfettiFired){confetti({particleCount:200,spread:100,origin:{y:0.6}});confettiSound.play();calorieConfettiFired=true;}else if(caloriePercent<100)calorieConfettiFired=false;
}

function submitCelebrate(){
  const confettiSound = document.getElementById('celebrationSound');
  confetti({ particleCount: 260, spread: 140, origin: { y: 0.6 } });
  confetti({ particleCount: 180, spread: 90, origin: { y: 0.65 } });
  confettiSound.play();
}

window.onload = async () => {
  setDefaultWeightDate();
  await loadGoalsFromDB();
  await loadWeightsFromDB();

  displayGoals();
  updateChart();
  calculateProgress();
};



const hamburger=document.getElementById('hamburger');
const mobileMenu=document.getElementById('mobile-menu');
hamburger.addEventListener('click',()=>{mobileMenu.style.display=mobileMenu.style.display==='flex'?'none':'flex';});
</script>

<!-- AUTH GUARD -->
<script>
  (async () => {
    try {
      await window.auth.requireAuth("/myfolder/index.html");
    } catch (e) {
      window.location.href = "/myfolder/index.html";
    }
  })();
</script>

</body>
</html>
